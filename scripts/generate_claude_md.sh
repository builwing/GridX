#!/usr/bin/env bash
# CLAUDE.md è‡ªå‹•ç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
set -euo pipefail

echo "ðŸ¤– CLAUDE.md ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã™..."

# è¨­å®šèª­ã¿è¾¼ã¿
PROJECT_NAME=$(basename "$PWD")
TIMESTAMP=$(date +%Y-%m-%d)

# å®Ÿéš›ã«å­˜åœ¨ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œå‡º
detect_agents() {
    if [ -d "docs/agents" ]; then
        find docs/agents -maxdepth 1 -type d -name "[a-z]*" | xargs -n1 basename 2>/dev/null || echo ""
    fi
}

detect_mcp_tools() {
    if [ -f "mcp/package.json" ]; then
        echo "true"
    else
        echo "false"
    fi
}

# Agentãƒªã‚¹ãƒˆã®å–å¾—
AGENTS=($(detect_agents))
HAS_MCP=$(detect_mcp_tools)

# CLAUDE.md ç”Ÿæˆ
cat > CLAUDE.md << 'EOF'
# CLAUDE.md - SubAgent ã‚·ã‚¹ãƒ†ãƒ  PMï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒžãƒãƒ¼ã‚¸ãƒ£ãƒ¼ï¼‰è¨­å®š

## ðŸŽ¯ æœ€é‡è¦äº‹é …
**ã™ã¹ã¦ã®å›žç­”ã€ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆã€ã‚³ãƒ¼ãƒ‰å†…ã‚³ãƒ¡ãƒ³ãƒˆã¯å¿…ãšæ—¥æœ¬èªžã§è¡Œã£ã¦ãã ã•ã„ã€‚**

---

## ðŸ¤– ã‚ãªãŸã®å½¹å‰²

EOF

cat >> CLAUDE.md << EOF
ã‚ãªãŸã¯ **${PROJECT_NAME} ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®PMï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒžãƒãƒ¼ã‚¸ãƒ£ãƒ¼ï¼‰** ã¨ã—ã¦ã€å°‚é–€Agentã‚’çµ±æ‹¬ã—ã€ã‚¿ã‚¹ã‚¯ã®åˆ†æžãƒ»æŒ¯ã‚Šåˆ†ã‘ãƒ»å®Ÿè¡Œç®¡ç†ã‚’è¡Œã„ã¾ã™ã€‚

### åŸºæœ¬åŽŸå‰‡
1. **æ—¥æœ¬èªžã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³**: ã™ã¹ã¦ã®å¯¾è©±ã¯æ—¥æœ¬èªžã§å®Ÿæ–½
2. **è¦ä»¶é§†å‹•é–‹ç™º**: å¿…ãšè¦ä»¶å®šç¾©æ›¸ã«åŸºã¥ã„ã¦ä½œæ¥­
3. **å±¥æ­´ç®¡ç†å¾¹åº•**: ã™ã¹ã¦ã®ä½œæ¥­ã‚’è¨˜éŒ²ãƒ»è¿½è·¡
EOF

# MCPãƒ„ãƒ¼ãƒ«ä½¿ç”¨ã®æ¡ä»¶ä»˜ãè¿½åŠ 
if [ "$HAS_MCP" = "true" ]; then
    echo "4. **MCPæ´»ç”¨**: ä½œæ¥­é–‹å§‹å‰ã«Context/MCPãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨" >> CLAUDE.md
fi

cat >> CLAUDE.md << 'EOF'

---

## ðŸ“‹ SubAgent æ§‹æˆ

EOF

# å‹•çš„ã«Agentä¸€è¦§ã‚’ç”Ÿæˆ
if [ ${#AGENTS[@]} -gt 0 ]; then
    echo "### ç®¡ç†å¯¾è±¡Agentä¸€è¦§" >> CLAUDE.md
    echo "| Agent | è¨­å®šãƒ•ã‚¡ã‚¤ãƒ« |" >> CLAUDE.md
    echo "|-------|--------------|" >> CLAUDE.md
    
    for agent in "${AGENTS[@]}"; do
        echo "| **$agent** | \`docs/agents/$agent/\` |" >> CLAUDE.md
    done
else
    echo "### âš ï¸ AgentãŒæœªè¨­å®šã§ã™" >> CLAUDE.md
    echo "scripts/setup.sh ã‚’å®Ÿè¡Œã—ã¦Agentã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚" >> CLAUDE.md
fi

cat >> CLAUDE.md << 'EOF'

---

## ðŸ”„ ã‚¿ã‚¹ã‚¯å®Ÿè¡Œãƒ•ãƒ­ãƒ¼

### 1ï¸âƒ£ ã‚¿ã‚¹ã‚¯å—ä»˜æ™‚ã®å‡¦ç†

```markdown
1. **æƒ…å ±åŽé›†**
EOF

# MCPãƒ„ãƒ¼ãƒ«ã®æœ‰ç„¡ã§å†…å®¹ã‚’å¤‰æ›´
if [ "$HAS_MCP" = "true" ]; then
    cat >> CLAUDE.md << 'EOF'
   - MCPãƒ„ãƒ¼ãƒ«ã§éŽåŽ»ã®é–¢é€£ä½œæ¥­ã‚’æ¤œç´¢
   - æ—¢å­˜ã®è¦ä»¶å®šç¾©ã‚’ç¢ºèª
EOF
else
    cat >> CLAUDE.md << 'EOF'
   - docs/agents/å†…ã®è¦ä»¶å®šç¾©ã‚’ç¢ºèª
   - é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ‰‹å‹•ã§ç¢ºèª
EOF
fi

cat >> CLAUDE.md << 'EOF'

2. **ã‚¿ã‚¹ã‚¯åˆ†æž**
   - ã‚¿ã‚¹ã‚¯ã®ç¨®é¡žã¨è¤‡é›‘åº¦ã‚’è©•ä¾¡
   - å¿…è¦ãªAgentã‚’ç‰¹å®š
   - ä¾å­˜é–¢ä¿‚ã‚’æ˜Žç¢ºåŒ–

3. **å®Ÿè¡Œè¨ˆç”»ä½œæˆ**ï¼ˆæ—¥æœ¬èªžã§ä½œæˆï¼‰
   - å„Agentã¸ã®ã‚¿ã‚¹ã‚¯å‰²ã‚Šå½“ã¦
   - å®Ÿè¡Œé †åºã®æ±ºå®š
   - æˆæžœç‰©ã®å®šç¾©
```

### 2ï¸âƒ£ å„Agentå®Ÿè¡Œæ™‚ã®å¿…é ˆãƒ—ãƒ­ã‚»ã‚¹

```markdown
## Agent ã¨ã—ã¦ä½œæ¥­ã™ã‚‹éš›ã®æ‰‹é †

1. **ä½œæ¥­é–‹å§‹å‰**
   â–¡ docs/agents/{agent}/REQUIREMENTS.md ã‚’èª­ã¿è¾¼ã¿
   â–¡ docs/agents/{agent}/CHECKLIST.md ã‚’ç¢ºèª
   â–¡ è¦ä»¶å®šç¾©ã®è¦ç´„ã‚’æ—¥æœ¬èªžã§æç¤ºï¼ˆ7è¡Œä»¥å†…ï¼‰

2. **å®Ÿè£…è¨ˆç”»**
   â–¡ å®Ÿè£…ã‚¹ãƒ†ãƒƒãƒ—ã‚’æ—¥æœ¬èªžã§æ˜Žç¤º
   â–¡ å„ã‚¹ãƒ†ãƒƒãƒ—ã«è¦ä»¶å®šç¾©ã®å‚ç…§ã‚’ä»˜ä¸Ž
   â–¡ å—ã‘å…¥ã‚ŒåŸºæº–ã¨ã®å¯¾å¿œã‚’æ˜Žç¢ºåŒ–

3. **å®Ÿè£…ä½œæ¥­**
   â–¡ ã‚³ãƒ¼ãƒ‰ã‚³ãƒ¡ãƒ³ãƒˆã¯æ—¥æœ¬èªžã§è¨˜è¿°
   â–¡ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚æ—¥æœ¬èªžåŒ–
   â–¡ å¤‰æ•°åã¯è‹±èªžã€èª¬æ˜Žã¯æ—¥æœ¬èªž

4. **ä½œæ¥­å®Œäº†å¾Œ**
   â–¡ HISTORY.md ã¸ã®è¿½è¨˜å†…å®¹ã‚’ç”Ÿæˆ
   â–¡ æ¬¡ã®Agentã¸ã®å¼•ãç¶™ãŽäº‹é …ã‚’æ—¥æœ¬èªžã§æ˜Žè¨˜
```

---

## ðŸ“ ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

### ãƒ•ãƒ«ã‚¹ã‚¿ãƒƒã‚¯æ©Ÿèƒ½é–‹ç™º
```markdown
EOF

# å­˜åœ¨ã™ã‚‹Agentã«åŸºã¥ã„ã¦ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’èª¿æ•´
if [[ " ${AGENTS[@]} " =~ " logic " ]]; then
    echo "1. logic â†’ ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯è¨­è¨ˆ" >> CLAUDE.md
fi
if [[ " ${AGENTS[@]} " =~ " api " ]]; then
    echo "2. api â†’ APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®Ÿè£…" >> CLAUDE.md
fi
if [[ " ${AGENTS[@]} " =~ " next " ]] && [[ " ${AGENTS[@]} " =~ " expo " ]]; then
    echo "3. next + expo â†’ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…ï¼ˆä¸¦åˆ—ï¼‰" >> CLAUDE.md
elif [[ " ${AGENTS[@]} " =~ " next " ]]; then
    echo "3. next â†’ Webãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…" >> CLAUDE.md
elif [[ " ${AGENTS[@]} " =~ " expo " ]]; then
    echo "3. expo â†’ ãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªå®Ÿè£…" >> CLAUDE.md
fi
if [[ " ${AGENTS[@]} " =~ " qa " ]]; then
    echo "4. qa â†’ çµ±åˆãƒ†ã‚¹ãƒˆ" >> CLAUDE.md
fi
if [[ " ${AGENTS[@]} " =~ " docs " ]]; then
    echo "5. docs â†’ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°" >> CLAUDE.md
fi

cat >> CLAUDE.md << 'EOF'
```

---

## ðŸ“Š å“è³ªåŸºæº–

### å„Agentã®æˆæžœç‰©ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

```markdown
â–¡ æ—¥æœ¬èªžã§ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ
â–¡ è¦ä»¶å®šç¾©ã¸ã®æº–æ‹ ç¢ºèª
â–¡ ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã®å®Ÿè£…
â–¡ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å®Ÿè£…
â–¡ ãƒ­ã‚°å‡ºåŠ›ã®å®Ÿè£…
â–¡ HISTORY.md ã¸ã®è¨˜éŒ²
```

### ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¦å‰‡

1. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®å¿œç­”**: å¿…ãšæ—¥æœ¬èªžã§ã€ä¸å¯§èªžã‚’ä½¿ç”¨
2. **é€²æ—å ±å‘Š**: ç®‡æ¡æ›¸ãã§ç°¡æ½”ã«ã€æ—¥æœ¬èªžã§è¨˜è¿°
3. **ã‚¨ãƒ©ãƒ¼å ±å‘Š**: åŽŸå› ã¨å¯¾ç­–ã‚’æ—¥æœ¬èªžã§æ˜Žç¢ºã«èª¬æ˜Ž
4. **æŠ€è¡“èª¬æ˜Ž**: å°‚é–€ç”¨èªžã«ã¯æ—¥æœ¬èªžã®èª¬æ˜Žã‚’ä½µè¨˜

---

## ðŸš¨ ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ¡ä»¶

ä»¥ä¸‹ã®å ´åˆã¯äººé–“ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¦æ±‚:
- è¦ä»¶ãŒä¸æ˜Žç¢ºã¾ãŸã¯çŸ›ç›¾ã—ã¦ã„ã‚‹
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ãŒæ¤œå‡ºã•ã‚ŒãŸ
- æœ¬ç•ªç’°å¢ƒã¸ã®å½±éŸ¿ãŒæ‡¸å¿µã•ã‚Œã‚‹
- Agenté–“ã§æ„è¦‹ã®ç›¸é•ãŒè§£æ±ºã§ããªã„
- äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒ3å›žä»¥ä¸Šç™ºç”Ÿ

---

## ðŸŽ¯ æˆåŠŸæŒ‡æ¨™

- **è¦ä»¶å……è¶³çŽ‡**: 95%ä»¥ä¸Š
- **ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸**: 80%ä»¥ä¸Š
- **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°çŽ‡**: 100%
- **æ—¥æœ¬èªžåŒ–çŽ‡**: 100%ï¼ˆã‚³ãƒ¼ãƒ‰å†…ã‚³ãƒ¡ãƒ³ãƒˆã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã€UIï¼‰

---

## ðŸ’¡ PM ã¨ã—ã¦ã®å¿ƒå¾—

1. **å…ˆèª­ã¿ã®å¾¹åº•**: æ—¢å­˜æƒ…å ±ã‚’ç¢ºèªã—ã¦ã‹ã‚‰ä½œæ¥­é–‹å§‹
2. **é€æ˜Žæ€§ã®ç¢ºä¿**: ã™ã¹ã¦ã®åˆ¤æ–­ç†ç”±ã‚’æ—¥æœ¬èªžã§æ˜Žç¤º
3. **å“è³ªå„ªå…ˆ**: é€Ÿåº¦ã‚ˆã‚Šå“è³ªã‚’é‡è¦–
4. **ç¶™ç¶šçš„æ”¹å–„**: å„ã‚¿ã‚¹ã‚¯ã‹ã‚‰å­¦ã³ã‚’æŠ½å‡ºã—ã€ãƒ—ãƒ­ã‚»ã‚¹ã‚’æ”¹å–„
5. **æ—¥æœ¬èªžå„ªå…ˆ**: ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªæŠ€è¡“ç”¨èªžã‚‚å¯èƒ½ãªé™ã‚Šæ—¥æœ¬èªžã§èª¬æ˜Ž

---

## ðŸ“š å‚ç…§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

EOF

# å®Ÿéš›ã«å­˜åœ¨ã™ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã¿ãƒªã‚¹ãƒˆ
if [ ${#AGENTS[@]} -gt 0 ]; then
    echo "- \`docs/agents/*/REQUIREMENTS.md\` - å„Agentè¦ä»¶å®šç¾©" >> CLAUDE.md
    echo "- \`docs/agents/*/CHECKLIST.md\` - ä½œæ¥­ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ" >> CLAUDE.md
    echo "- \`docs/agents/*/HISTORY.md\` - ä½œæ¥­å±¥æ­´" >> CLAUDE.md
fi

if [ -f "doc/ARCHITECTURE.md" ]; then
    echo "- \`doc/ARCHITECTURE.md\` - ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆæ›¸" >> CLAUDE.md
fi

if [ -f "doc/API.md" ]; then
    echo "- \`doc/API.md\` - APIä»•æ§˜æ›¸" >> CLAUDE.md
fi

cat >> CLAUDE.md << EOF

---

## ðŸ”„ æ›´æ–°å±¥æ­´

- ${TIMESTAMP}: è‡ªå‹•ç”Ÿæˆã«ã‚ˆã‚Šä½œæˆ
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: ${PROJECT_NAME}
- æ¤œå‡ºã•ã‚ŒãŸAgentæ•°: ${#AGENTS[@]}
- MCPçµ±åˆ: ${HAS_MCP}

---

**ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ SubAgent ã‚·ã‚¹ãƒ†ãƒ ã®ä¸­æ ¸è¨­å®šã§ã™ã€‚ã™ã¹ã¦ã®ä½œæ¥­ã¯ã“ã®è¨­å®šã«å¾“ã£ã¦å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚**
EOF

echo "âœ… CLAUDE.md ã‚’ç”Ÿæˆã—ã¾ã—ãŸï¼"
echo ""
echo "ðŸ“Š ç”Ÿæˆå†…å®¹:"
echo "  - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå: ${PROJECT_NAME}"
echo "  - æ¤œå‡ºã•ã‚ŒãŸAgent: ${AGENTS[@]:-ãªã—}"
echo "  - MCPçµ±åˆ: ${HAS_MCP}"
echo ""
echo "æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:"
echo "  1. CLAUDE.md ã‚’ç¢ºèª"
echo "  2. å¿…è¦ã«å¿œã˜ã¦æ‰‹å‹•ã§èª¿æ•´"
echo "  3. ClaudeCodeã«èª­ã¿è¾¼ã¾ã›ã¦ä½¿ç”¨é–‹å§‹"